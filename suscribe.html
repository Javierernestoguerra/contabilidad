<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suscripción Push – Contabilidad</title>
  <meta name="theme-color" content="#2563eb" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb;margin:0}
    main{max-width:680px;margin:32px auto;padding:16px}
    h1{font-size:22px;margin:0 0 12px}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:16px}
    button{background:#2563eb;color:white;border:0;padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:700}
    button:disabled{opacity:.6;cursor:not-allowed}
    pre{background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:12px;white-space:pre-wrap;word-break:break-word}
    .ok{color:#22c55e;font-weight:700}
    .err{color:#ef4444;font-weight:700}
    .muted{color:#9aa9bf}
  </style>
</head>
<body>
  <main>
    <h1>Suscripción Push</h1>
    <div class="card">
      <p>Esta página te ayuda a crear y registrar tu suscripción de notificaciones <strong>sin usar la consola</strong>.</p>
      <ol class="muted" style="margin:8px 0 16px 18px">
        <li>Haz clic en el botón de abajo.</li>
        <li>Acepta el permiso de notificaciones cuando el navegador lo pida.</li>
        <li>Verás tu suscripción y el resultado del registro.</li>
      </ol>
      <button id="btn">Suscribirme y registrar</button>
      <p id="status" class="muted" style="margin:12px 0 0 0">Estado: esperando…</p>
    </div>

    <div class="card" style="margin-top:16px">
      <h2 style="font-size:18px;margin:0 0 8px">Subscription JSON</h2>
      <pre id="out">—</pre>
    </div>
  </main>

<script type="module">
  // === Ajustes de tu proyecto ===
  const VAPID_PUBLIC_KEY = "BGwlTsTs46JJT3KkUkTYKrh_3eocHNKI6QaNvv-a3ufgHAnwsv9vn2wTkymdlccVhLSZYCm6VGySCxcKj2S4p9w";
  // Tu Edge Function que ya responde:
  const FUNCTION_BASE = "https://mcmzclmbpohddblpulmn.supabase.co/functions/v1/super-processor";

  // Comprobaciones rápidas
  const $ = s => document.querySelector(s);
  const btn = $('#btn');
  const out = $('#out');
  const status = $('#status');

  function logStatus(msg, cls="muted"){
    status.className=cls; status.textContent = "Estado: " + msg;
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(base64);
    const outputArray = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) outputArray[i] = raw.charCodeAt(i);
    return outputArray;
  }

  async function ensureServiceWorker(){
    // Registramos el SW de la app para poder suscribir Push
    if (!('serviceWorker' in navigator)) throw new Error('Navegador sin Service Worker.');
    const isSecure = window.isSecureContext || ['localhost','127.0.0.1'].includes(location.hostname);
    if (!isSecure) throw new Error('Este origen no es seguro (necesitas HTTPS).');

    // Debe existir en la misma carpeta que index.html (raíz del repo)
    const reg = await navigator.serviceWorker.register('service-worker.js');
    // Esperar a que esté listo
    await navigator.serviceWorker.ready;
    return reg;
  }

  async function getOrCreateSubscription(reg){
    if (!('PushManager' in window)) throw new Error('Navegador sin PushManager.');
    let permission = Notification.permission;
    if (permission === 'default') permission = await Notification.requestPermission();
    if (permission !== 'granted') throw new Error('Permiso de notificaciones denegado.');

    let sub = await reg.pushManager.getSubscription();
    if (!sub) {
      sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
      });
    }
    return sub;
  }

  async function registerOnServer(subscription, userEmail){
    const res = await fetch(`${FUNCTION_BASE}/register`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ subscription: subscription.toJSON(), user_email: userEmail })
    });
    const text = await res.text();
    return { ok: res.ok, text };
  }

  btn.addEventListener('click', async () => {
    btn.disabled = true;
    out.textContent = '—';
    logStatus('iniciando…');

    try{
      const reg = await ensureServiceWorker();
      logStatus('SW listo en: ' + reg.scope);

      const sub = await getOrCreateSubscription(reg);
      const json = JSON.stringify(sub.toJSON(), null, 2);
      out.textContent = json;

      // Puedes cambiar este correo por el del usuario actual si quieres
      const userEmail = 'prueba@correo.com';

      logStatus('registrando en servidor…');
      const result = await registerOnServer(sub, userEmail);

      if (result.ok) {
        logStatus('suscripción registrada ✔', 'ok');
      } else {
        logStatus('error al registrar: ' + result.text, 'err');
      }
    }catch(err){
      logStatus(err.message || String(err), 'err');
    }finally{
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
