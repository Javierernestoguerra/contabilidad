<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diagnóstico Push</title>
<meta name="theme-color" content="#2563eb" />
<style>
  body{font-family:system-ui,Segoe UI,Arial,sans-serif;background:#0b1220;color:#e5e7eb;margin:0}
  main{max-width:760px;margin:24px auto;padding:16px}
  h1{font-size:22px;margin:0 0 12px}
  .card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:16px;margin-bottom:12px}
  .row{display:grid;grid-template-columns:220px 1fr;gap:8px;margin:6px 0}
  code,pre{background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:8px}
  button{background:#2563eb;color:#fff;border:0;padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:700}
  button:disabled{opacity:.6;cursor:not-allowed}
  .ok{color:#22c55e;font-weight:700}
  .err{color:#ef4444;font-weight:700}
  .muted{color:#9aa9bf}
</style>
</head>
<body>
<main>
  <h1>Diagnóstico & Suscripción Push</h1>

  <div class="card">
    <div class="row"><div>URL actual</div><div><code id="href">—</code></div></div>
    <div class="row"><div>HTTPS / Contexto seguro</div><div id="secure">—</div></div>
    <div class="row"><div>Service Worker</div><div id="sw">—</div></div>
    <div class="row"><div>Permiso de notificaciones</div><div id="perm">—</div></div>
    <div class="row"><div>Función /ping</div><div id="ping">—</div></div>
  </div>

  <div class="card">
    <button id="btn">Suscribirme y registrar</button>
    <span id="status" class="muted" style="margin-left:10px">Esperando…</span>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:18px">Subscription JSON</h2>
    <pre id="out">—</pre>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:18px">Si sale “denegado”</h2>
    <ol class="muted" style="margin:0 0 0 18px">
      <li>Haz clic en el candado (izquierda de la URL) → <strong>Notificaciones: Permitir</strong>.</li>
      <li><strong>Windows</strong>: Configuración → Sistema → Notificaciones → Activa y permite Chrome/Edge.</li>
      <li><strong>Android</strong>: Ajustes → Notificaciones → Chrome → Permitir notificaciones.</li>
      <li><strong>iPhone/iPad</strong>: Debes <strong>instalar la app</strong> (Añadir a pantalla de inicio) y permitir notificaciones en Ajustes → Notificaciones (iOS 16.4+).</li>
      <li>Desactiva “Usar mensajería más silenciosa”: en Chrome entra a <code>chrome://settings/content/notifications</code> y desmarca el modo silencioso.</li>
      <li>Prueba ventana incógnito (permisos limpios) o “Clear site data” en Application → Clear storage.</li>
    </ol>
  </div>
</main>

<script type="module">
  const VAPID_PUBLIC_KEY = "BGwlTsTs46JJT3KkUkTYKrh_3eocHNKI6QaNvv-a3ufgHAnwsv9vn2wTkymdlccVhLSZYCm6VGySCxcKj2S4p9w";
  // Tu función que ya responde a /ping:
  const FUNCTION_BASE = "https://mcmzclmbpohddblpulmn.supabase.co/functions/v1/super-processor";

  const $ = s => document.querySelector(s);
  const href = $('#href'), secure = $('#secure'), sw=$('#sw'), perm=$('#perm'), ping=$('#ping');
  const status = $('#status'), out=$('#out'), btn=$('#btn');

  href.textContent = location.href;

  // HTTPS / Secure Context
  const isSecure = window.isSecureContext || ['localhost','127.0.0.1'].includes(location.hostname);
  secure.innerHTML = isSecure ? '<span class="ok">Sí</span>' : '<span class="err">No (necesitas HTTPS)</span>';

  // SW presente y listo?
  (async () => {
    if (!('serviceWorker' in navigator)) { sw.innerHTML='<span class="err">No soportado</span>'; return; }
    try{
      const reg = await navigator.serviceWorker.register('service-worker.js');
      await navigator.serviceWorker.ready;
      sw.innerHTML = '<span class="ok">Listo</span>';
    }catch(e){
      sw.innerHTML = '<span class="err">Fallo registro</span>';
    }
  })();

  // Permiso actual
  function paintPerm(){
    const p = Notification.permission;
    perm.innerHTML = p === 'granted'
      ? '<span class="ok">granted</span>'
      : (p === 'denied' ? '<span class="err">denied</span>' : '<span class="muted">default</span>');
  }
  paintPerm();

  // Ping función
  (async () => {
    try{
      const r = await fetch(`${FUNCTION_BASE}/ping`);
      ping.innerHTML = r.ok ? '<span class="ok">OK</span>' : '<span class="err">'+r.status+'</span>';
    }catch{ ping.innerHTML = '<span class="err">falló</span>'; }
  })();

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(base64);
    const output = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
    return output;
  }

  async function subscribeAndRegister(){
    try{
      status.textContent = 'Pidiendo permiso…';
      let p = Notification.permission;
      if (p === 'default') p = await Notification.requestPermission();
      paintPerm();
      if (p !== 'granted') throw new Error('Permiso de notificaciones denegado por el navegador.');

      status.textContent = 'Creando suscripción…';
      const reg = await navigator.serviceWorker.ready;
      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
        });
      }
      out.textContent = JSON.stringify(sub.toJSON(), null, 2);

      status.textContent = 'Registrando en servidor…';
      const res = await fetch(`${FUNCTION_BASE}/register`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ subscription: sub.toJSON(), user_email: 'prueba@correo.com' })
      });
      const text = await res.text();
      if (!res.ok) throw new Error(text);
      status.innerHTML = '<span class="ok">Suscripción registrada ✔</span>';
    }catch(e){
      status.innerHTML = '<span class="err">'+(e.message||String(e))+'</span>';
    }
  }

  btn.addEventListener('click', () => { btn.disabled=true; subscribeAndRegister().finally(()=>btn.disabled=false) });
</script>
</body>
</html>

