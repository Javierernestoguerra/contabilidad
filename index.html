<!DOCTYPE html>
<html lang="es">
<head>

<link rel="manifest" href="/contabilidad/manifest.webmanifest">
<meta name="theme-color" content="#111827">


<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Control de Fondos CUP/USD ‚Äì Supabase</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif}
  body{background:#f6f7fb;color:#0f172a;display:flex;flex-direction:column;min-height:100vh}

  /* Header */
  header{background:#ffffff;border-bottom:1px solid #e2e8f0;padding:8px 12px;display:flex;justify-content:flex-end;align-items:center;gap:10px}
  #user-info{font-size:14px;display:flex;align-items:center;gap:10px}
  #logout{background:#dc2626;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}

  main{flex:1;display:flex;flex-direction:column}
  #content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px}

  /* Topbar: chips, filtro y acciones */
  .topbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .chip{padding:4px 8px;border:1px solid #e2e8f0;border-radius:999px;background:#ffffff;font-size:12px;cursor:pointer}
  .chip strong{font-weight:800}
  .chip.active{border-color:#2563eb;color:#2563eb;background:#eff6ff}
  .filter{padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;font-size:12px;background:#fff}
  .btn{padding:8px 12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
  .btn.green{background:#16a34a;color:#fff}
  .btn.red{background:#dc2626;color:#fff}

  /* Tabla */
  .table-wrap{overflow:auto;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #e5e7eb;padding:6px 6px;font-size:13px;vertical-align:middle}
  th{background:#f1f5f9;color:#0f172a;text-align:left;position:sticky;top:0;z-index:1}
  td.num{text-align:right;font-variant-numeric:tabular-nums}
  tr.verified{background:#dcfce7 !important}
  .nowrap{white-space:nowrap}

  /* Paginaci√≥n */
  .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
  .pagination button{padding:8px 12px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer}

  /* Modal */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:100}
  .modal{background:#fff;padding:16px;border-radius:12px;width:92%;max-width:420px;position:relative;display:flex;flex-direction:column;gap:10px}
  .modal .close{position:absolute;right:10px;top:10px;background:transparent;border:none;font-size:18px;cursor:pointer}
  .modal label{display:flex;flex-direction:column;gap:6px}
  .modal input{padding:10px;border:1px solid #cbd5e1;border-radius:8px}
  .modal .ok{background:#2563eb;color:#fff;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer}

  /* Login moderno */
  .login-wrap{
    flex:1;display:flex;align-items:center;justify-content:center;
    background: linear-gradient(135deg,#2e62ff 0%, #6b3dfd 100%);
    padding:24px;
  }
  .card{
    width:100%;max-width:380px;background:#fff;border-radius:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15);
    padding:20px 18px; display:flex; flex-direction:column; gap:12px;
  }
  .card h2{font-size:22px;text-align:center;margin-bottom:8px;color:#111827}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:#475569}
  .field input{
    padding:12px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px
  }
  .login-btn{
    margin-top:4px;padding:12px;border:none;border-radius:10px;
    background:#2563eb;color:#fff;font-weight:700;cursor:pointer
  }
  .login-error{color:#dc2626;font-size:12px;min-height:16px;text-align:center}
  .hint{font-size:12px;color:#64748b;text-align:center}

  /* Loader inicial para evitar ‚Äúflash‚Äù del login */
  #loading{
    position:fixed;inset:0;display:flex;
    align-items:center;justify-content:center;
    background:#f8fafc;color:#1e293b;
    font-size:16px;z-index:9999;
  }

  #toast{position:fixed;bottom:16px;right:16px;background:#16a34a;color:white;padding:10px 16px;border-radius:8px;opacity:0;transition:opacity .25s}
  #toast.show{opacity:1}

  .hidden{display:none !important}
</style>
</head>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/contabilidad/service-worker.js", { scope: "/contabilidad/" })
      .catch(console.error);
  }
</script>


<body>

<!-- Loader (se oculta cuando Supabase confirma el estado de sesi√≥n) -->
<div id="loading">Cargando...</div>

<header>
  <div id="user-info" style="display:none">
    Sesi√≥n: <span id="activeUser"></span>
    <button id="logout">Cerrar sesi√≥n</button>
  </div>
</header>

<main>
  <!-- App -->
  <div id="content" class="hidden">
    <div class="topbar">
      <button id="chipCUP" class="chip active" title="Ver CUP">CUP: <strong id="totalCUP">0</strong></button>
      <button id="chipUSD" class="chip" title="Ver USD">USD: <strong id="totalUSD">0</strong></button>
      <select id="filterSelect" class="filter" title="Filtrar">
        <option value="ALL">Todos</option>
        <option value="TODAY">Hoy</option>
        <option value="YESTERDAY">Ayer</option>
        <option value="TODAY_YESTERDAY">Ayer-Hoy</option>
        <option value="LAST_CHECK">√öltimo CheckBox</option>
      </select>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button id="btnEntrada" class="btn green">Entrada</button>
        <button id="btnSalida" class="btn red">Salida</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tabla">
        <thead>
          <tr>
            <th style="width:1%;" class="nowrap">Fecha</th>
            <th class="num">Entradas</th>
            <th class="num">Salidas</th>
            <th style="min-width:120px">Descripci√≥n</th>
            <th class="num">Saldo</th>
            <th class="num" style="width:1%">‚úî</th>
            <th class="num" style="width:1%">‚úèÔ∏è</th>
            <th class="num" style="width:1%">üóë</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pagination">
      <span id="pageInfo" style="margin-right:auto;color:#475569"></span>
      <button id="prevPage">‚óÄÔ∏è Anterior</button>
      <button id="nextPage">Siguiente ‚ñ∂Ô∏è</button>
    </div>
  </div>

  <!-- Login moderno -->
  <div id="login" class="login-wrap">
    <div class="card">
      <h2>Iniciar sesi√≥n</h2>
      <div id="loginError" class="login-error"></div>
      <div class="field">
        <label for="email">Correo</label>
        <input id="email" type="email" placeholder="tu@correo.com" autocomplete="username" />
      </div>
      <div class="field">
        <label for="password">Contrase√±a</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
      <button id="loginBtn" class="login-btn">Iniciar sesi√≥n</button>
      <div class="hint">Usuarios configurados: Javi, Amaury y Yanilsa</div>
    </div>
  </div>
</main>

<div id="toast">Operaci√≥n registrada correctamente</div>

<template id="rowTpl">
  <tr>
    <td data-k="fecha" class="nowrap"></td>
    <td data-k="entradas" class="num"></td>
    <td data-k="salidas" class="num"></td>
    <td data-k="desc"></td>
    <td data-k="saldo" class="num"></td>
    <td class="num"><input type="checkbox" class="check" title="Verificado" /></td>
    <td class="num"><button class="edit" title="Editar" style="background:transparent;border:none;cursor:pointer;font-size:16px">‚úèÔ∏è</button></td>
    <td class="num">
      <button class="del" title="Eliminar" style="background:transparent;border:none;cursor:pointer;display:inline-flex;align-items:center" aria-label="Eliminar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
          <path d="M10 11v6"/>
          <path d="M14 11v6"/>
          <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
        </svg>
      </button>
    </td>
  </tr>
</template>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const SUPABASE_URL  = "https://mcmzclmbpohddblpulmn.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbXpjbG1icG9oZGRibHB1bG1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5ODM5OTMsImV4cCI6MjA3NTU1OTk5M30.bdxIDJXk-ovzaGhz3GaQV740bHA0r9sLC4Io8QEOAR0";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  const $ = s => document.querySelector(s);
  window.opsAll = []; window.currentCurrency='CUP'; window.currentFilter='ALL'; window.PAGE_SIZE=15; window.page=1;

  /* ================= LOGIN ================= */
  async function doLogin(email,password){
    $('#loginError').textContent='';
    const {error}=await supabase.auth.signInWithPassword({email,password});
    if(error){$('#loginError').textContent=error.message;return false;}
    return true;
  }
  $('#loginBtn').onclick=async()=>{
    const email=$('#email').value.trim(),pass=$('#password').value;
    if(!email||!pass){$('#loginError').textContent='Completa correo y contrase√±a.';return;}
    await doLogin(email,pass);
  };
  $('#password').addEventListener('keydown',e=>{
    if(e.key==='Enter')$('#loginBtn').click();
  });

  /* LOGOUT inmediato */
  $('#logout').onclick=async()=>{
    await supabase.auth.signOut();
    localStorage.removeItem('sb-access-token');
    localStorage.removeItem('supabase.auth.token');
    $('#user-info').style.display='none';
    $('#content').classList.add('hidden');
    $('#login').classList.remove('hidden');
  };

  /* ================= DATA ================= */
  async function fetchAll(){
    const {data,error}=await supabase.from('operations').select('*').order('date',{ascending:true});
    if(!error){window.opsAll=data||[];window.page=getTotalPages();window.render();}
  }

  /* REAlTIME mejorado */
  let channel=null;
  function startRealtime(){
    if(channel) supabase.removeChannel(channel);
    channel=supabase.channel('realtime:operations_all')
      .on('postgres_changes',
        {event:'*',schema:'public',table:'operations'},
        payload=>{
          console.log('Evento realtime recibido:',payload);
          fetchAll(); // refresco inmediato
        })
      .subscribe(status=>console.log('Estado canal:',status));
  }

  /* Loader inicial */
  document.getElementById('loading').style.display='flex';
  supabase.auth.onAuthStateChange((_,session)=>{
    const logged=!!session;
    if(logged){
      $('#user-info').style.display='flex';
      $('#activeUser').textContent=session.user.email;
      $('#login').classList.add('hidden');
      $('#content').classList.remove('hidden');
      startRealtime(); fetchAll();
    }else{
      $('#user-info').style.display='none';
      $('#content').classList.add('hidden');
      $('#login').classList.remove('hidden');
    }
    document.getElementById('loading').style.display='none';
  });

  /* CRUD */
  window.addOperation=async d=>{
    const {error}=await supabase.from('operations').insert(d);
    if(error)alert('Insert:'+error.message);
  };
  window.editOperation=async(id,u)=>{
    const{error}=await supabase.from('operations').update(u).eq('id',id);
    if(error)alert('Update:'+error.message);
  };
  window.deleteOperation=async id=>{
    const{error}=await supabase.from('operations').delete().eq('id',id);
    if(error)alert('Delete:'+error.message);
  };
  window.toggleVerified=async(id,v)=>{
    const{error}=await supabase.from('operations').update({verified:!!v}).eq('id',id);
    if(error)alert('Check:'+error.message);
  };

  /* === utilidades === */
  function fmtNum(n){return(Number(n)||0).toLocaleString('es-ES',{maximumFractionDigits:2})}
  function fmtDateShortISO(i){const d=new Date(i);return`${d.getDate()}-${d.getMonth()+1}-${String(d.getFullYear()).slice(-2)}`}
  function toYMD(d){const x=new Date(d);return`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`}
  function ymdOffset(days){const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()+days);return toYMD(d)}
  function toast(m='Operaci√≥n registrada'){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700)}

  /* === Totales / filtros === */
  function calcTotals(){
    const asc=[...opsAll].sort((a,b)=>new Date(a.date)-new Date(b.date));
    let sC=0,sU=0,m=new Map();
    asc.forEach(o=>{
      const d=(o.type==='Entrada'?1:-1)*(+o.amount||0);
      if(o.currency==='CUP'){sC+=d;m.set(o.id,{saldo:sC});}
      if(o.currency==='USD'){sU+=d;m.set(o.id,{saldo:sU});}
    });
    $('#totalCUP').textContent=fmtNum(sC);$('#totalUSD').textContent=fmtNum(sU);
    return m;
  }
  function applyFilter(list){
    const f=currentFilter; if(f==='ALL')return list;
    const t=ymdOffset(0),y=ymdOffset(-1);
    if(f==='TODAY')return list.filter(o=>toYMD(o.date)===t);
    if(f==='YESTERDAY')return list.filter(o=>toYMD(o.date)===y);
    if(f==='TODAY_YESTERDAY')return list.filter(o=>[t,y].includes(toYMD(o.date)));
    if(f==='LAST_CHECK'){const asc=[...list].sort((a,b)=>new Date(a.date)-new Date(b.date));
      const last=asc.map((o,i)=>({o,i})).reverse().find(x=>x.o.verified)?.i??-1;
      return last===-1?asc:asc.slice(last);}
    return list;
  }
  function filteredRows(){
    const map=calcTotals();
    let base=[...opsAll].filter(o=>o.currency===currentCurrency).sort((a,b)=>new Date(a.date)-new Date(b.date));
    base=applyFilter(base);
    return base.map(o=>({...o,saldo:(map.get(o.id)||{}).saldo||0,
      entradas:o.type==='Entrada'?o.amount:0,salidas:o.type==='Salida'?o.amount:0}));
  }
  function getTotalPages(){
    let l=[...opsAll].filter(o=>o.currency===currentCurrency).sort((a,b)=>new Date(a.date)-new Date(b.date));
    l=applyFilter(l); return Math.max(1,Math.ceil(l.length/PAGE_SIZE));
  }

  /* === Render tabla === */
  window.render=function(){
    const tb=$('#tabla tbody');tb.innerHTML='';
    const rows=filteredRows(); const total=rows.length;
    const totP=Math.max(1,Math.ceil(total/PAGE_SIZE));
    if(page>totP)page=totP;
    const s=(page-1)*PAGE_SIZE,e=s+PAGE_SIZE,pag=rows.slice(s,e);
    const tpl=$('#rowTpl');
    pag.forEach(o=>{
      const tr=tpl.content.cloneNode(true);
      tr.querySelector('[data-k="fecha"]').textContent=fmtDateShortISO(o.date);
      tr.querySelector('[data-k="entradas"]').textContent=o.entradas?fmtNum(o.entradas):'';
      tr.querySelector('[data-k="salidas"]').textContent=o.salidas?fmtNum(o.salidas):'';
      tr.querySelector('[data-k="desc"]').textContent=o.description||'';
      tr.querySelector('[data-k="saldo"]').textContent=fmtNum(o.saldo||0);
      const row=tr.querySelector('tr');
      if(o.verified)row.classList.add('verified');
      const chk=tr.querySelector('.check');
      chk.checked=!!o.verified;
      chk.onchange=()=>{toggleVerified(o.id,chk.checked);
        row.classList.toggle('verified',chk.checked);}
      tr.querySelector('.edit').onclick=()=>openEditModal(o);
      tr.querySelector('.del').onclick=()=>{if(confirm('¬øEliminar?'))deleteOperation(o.id);}
      tb.appendChild(tr);
    });
    $('#pageInfo').textContent=`${currentCurrency} ‚Äî P√°gina ${page} de ${totP} ‚Äî ${total} ops`;
    $('#prevPage').disabled=page<=1;$('#nextPage').disabled=page>=totP;
  };

  /* === Modales === */
  function openQuickModal(tipo){
    const bg=document.createElement('div');bg.className='modal-bg';
    const m=document.createElement('div');m.className='modal';
    m.innerHTML=`<button class="close">‚úñ</button><h3>${tipo}</h3>
      <label>Monto<input id="monto" type="number" placeholder="0"/></label>
      <label>Descripci√≥n<input id="desc" type="text" placeholder="Obligatorio"/></label>
      <button class="ok">Registrar</button>`;
    const close=()=>bg.remove();m.querySelector('.close').onclick=close;
    bg.onclick=e=>{if(e.target===bg)close();}
    m.querySelector('.ok').onclick=async()=>{
      const monto=+m.querySelector('#monto').value||0;
      const desc=m.querySelector('#desc').value.trim();
      if(monto<=0){alert('Monto inv√°lido');return;}
      if(!desc){alert('Descripci√≥n obligatoria');return;}
      await addOperation({currency:currentCurrency,type:tipo,amount:monto,description:desc});
      toast(); page=getTotalPages(); render(); close();
    };
    bg.appendChild(m);document.body.appendChild(bg);
  }
  function openEditModal(op){
    const bg=document.createElement('div');bg.className='modal-bg';
    const m=document.createElement('div');m.className='modal';
    m.innerHTML=`<button class="close">‚úñ</button><h3>Editar</h3>
      <div style="display:flex;gap:6px"><button class="tEntrada btn">Entrada</button><button class="tSalida btn">Salida</button></div>
      <label>Monto<input id="monto" type="number" value="${op.amount}"/></label>
      <label>Descripci√≥n<input id="desc" type="text" value="${op.description||''}"/></label>
      <button class="ok">Guardar</button>`;
    let tipo=op.type;
    const paint=()=>{m.querySelector('.tEntrada').style.background=tipo==='Entrada'?'#2563eb':'#e2e8f0';
      m.querySelector('.tEntrada').style.color=tipo==='Entrada'?'#fff':'#000';
      m.querySelector('.tSalida').style.background=tipo==='Salida'?'#2563eb':'#e2e8f0';
      m.querySelector('.tSalida').style.color=tipo==='Salida'?'#fff':'#000';};
    paint();
    m.querySelector('.tEntrada').onclick=()=>{tipo='Entrada';paint();};
    m.querySelector('.tSalida').onclick=()=>{tipo='Salida';paint();};
    m.querySelector('.ok').onclick=async()=>{
      const monto=+m.querySelector('#monto').value||0;
      const desc=m.querySelector('#desc').value.trim();
      if(monto<=0){alert('Monto inv√°lido');return;}
      if(!desc){alert('Descripci√≥n obligatoria');return;}
      await editOperation(op.id,{type:tipo,amount:monto,description:desc});
      toast('Guardado');render();bg.remove();
    };
    m.querySelector('.close').onclick=()=>bg.remove();
    bg.onclick=e=>{if(e.target===bg)bg.remove();}
    bg.appendChild(m);document.body.appendChild(bg);
  }

  /* === eventos === */
  function attach(){
    $('#chipCUP').onclick=()=>{currentCurrency='CUP';$('#chipCUP').classList.add('active');$('#chipUSD').classList.remove('active');page=getTotalPages();render();}
    $('#chipUSD').onclick=()=>{currentCurrency='USD';$('#chipUSD').classList.add('active');$('#chipCUP').classList.remove('active');page=getTotalPages();render();}
    $('#btnEntrada').onclick=()=>openQuickModal('Entrada');
    $('#btnSalida').onclick=()=>openQuickModal('Salida');
    $('#filterSelect').onchange=e=>{currentFilter=e.target.value;page=getTotalPages();render();}
    $('#prevPage').onclick=()=>{if(page>1){page--;render();}}
    $('#nextPage').onclick=()=>{const t=getTotalPages();if(page<t){page++;render();}}
  }
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',attach);else attach();
</script>
</body>
</html>

