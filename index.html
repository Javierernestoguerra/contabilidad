<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Control de Fondos CUP/USD ‚Äì Supabase</title>

<!-- PWA essentials -->
<meta name="theme-color" content="#2563eb" />
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

<style>
  :root{
    --bg:#f6f7fb; --text:#0f172a; --card:#ffffff; --border:#e2e8f0;
    --muted:#475569; --muted2:#64748b; --thead:#f1f5f9; --chipActive:#eff6ff;
    --primary:#2563eb; --danger:#dc2626; --success:#16a34a; --overlay:rgba(0,0,0,.4);
  }
  .dark{
    --bg:#0b1220; --text:#e5e7eb; --card:#0f172a; --border:#1f2937;
    --muted:#93a3b8; --muted2:#9aa9bf; --thead:#111827; --chipActive:#0f1e3a;
    --primary:#3b82f6; --danger:#ef4444; --success:#22c55e; --overlay:rgba(0,0,0,.6);
  }

  *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif}
  body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh}

  header{
    position:relative;background:var(--card);border-bottom:1px solid var(--border);
    padding:8px 12px;display:flex;align-items:center;gap:10px;justify-content:space-between
  }
  .header-left{display:flex;align-items:center;gap:8px}
  .menu-btn,.theme-btn,.install-btn{
    background:var(--card);border:1px solid var(--border);border-radius:10px;
    padding:6px 10px;cursor:pointer;color:var(--text)
  }
  .menu-dropdown{
    position:absolute;top:42px;left:12px;background:var(--card);border:1px solid var(--border);
    border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.12);overflow:hidden;display:none;min-width:180px;z-index:1000
  }
  .menu-dropdown button{
    display:block;width:100%;text-align:left;padding:10px 12px;border:none;
    background:var(--card);cursor:pointer;font-size:14px;color:var(--text)
  }
  .menu-dropdown button:hover{background:var(--thead)}

  #user-info{font-size:14px;display:flex;align-items:center;gap:10px;white-space:nowrap}
  #activeUserShort{font-weight:700}
  #logout{background:var(--danger);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}

  main{flex:1;display:flex;flex-direction:column}
  #content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px}

  .topbar,.stats-topbar,.calc-topbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-size:12px;cursor:pointer;color:var(--text)}
  .chip strong{font-weight:800}
  .chip.active{border-color:var(--primary);color:var(--primary);background:var(--chipActive)}
  .filter{padding:6px 8px;border:1px solid var(--border);border-radius:8px;font-size:12px;background:var(--card);color:var(--text)}
  .btn{padding:8px 12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
  .btn.green{background:var(--success);color:#fff}
  .btn.red{background:var(--danger);color:#fff}
  .btn.blue{background:var(--primary);color:#fff}

  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:10px;background:var(--card)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:6px 6px;font-size:13px;vertical-align:middle;color:var(--text)}
  th{background:var(--thead);text-align:left;position:sticky;top:0;z-index:1}
  td.num{text-align:right;font-variant-numeric:tabular-nums}
  tr.verified{background:#dcfce7 !important}
  .dark tr.verified{background:#12351d !important}
  .nowrap{white-space:nowrap}

  .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
  .pagination button{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;color:var(--text)}

  .modal-bg{position:fixed;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center;z-index:100}
  .modal{background:var(--card);color:var(--text);padding:16px;border-radius:12px;width:92%;max-width:420px;position:relative;display:flex;flex-direction:column;gap:10px;border:1px solid var(--border)}
  .modal .close{position:absolute;right:10px;top:10px;background:transparent;border:none;font-size:18px;cursor:pointer;color:var(--text)}
  .modal label{display:flex;flex-direction:column;gap:6px}
  .modal input{padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--card);color:var(--text)}
  .modal .ok{background:var(--primary);color:#fff;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer}
  .muted{color:var(--muted2);font-size:12px}

  .login-wrap{
    flex:1;display:flex;align-items:center;justify-content:center;
    background: linear-gradient(135deg,#2e62ff 0%, #6b3dfd 100%); padding:24px;
  }
  .dark .login-wrap{background:linear-gradient(135deg,#182544 0%, #2c1f5a 100%);}
  .card{
    width:100%;max-width:380px;background:var(--card);border:1px solid var(--border);border-radius:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15);
    padding:20px 18px; display:flex; flex-direction:column; gap:12px; color:var(--text)
  }
  .card h2{font-size:22px;text-align:center;margin-bottom:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input{padding:12px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:var(--card);color:var(--text)}
  .login-btn{margin-top:4px;padding:12px;border:none;border-radius:10px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
  .login-error{color:var(--danger);font-size:12px;min-height:16px;text-align:center}
  .hint{font-size:12px;color:var(--muted);text-align:center}

  #loading{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:var(--bg);color:var(--text);font-size:16px;z-index:9999;
  }

  .cards{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (min-width:640px){ .cards{grid-template-columns:repeat(4,1fr);} }
  .card-kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .card-kpi h4{font-size:12px;color:var(--muted);margin-bottom:6px}
  .card-kpi .val{font-size:18px;font-weight:800}
  .months{margin-top:8px;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:auto}
  .months table{width:100%;border-collapse:collapse}
  .months th,.months td{border-bottom:1px solid var(--border);padding:8px;font-size:13px}
  .months th{background:var(--thead);text-align:left}

  #toast{position:fixed;bottom:16px;right:16px;background:var(--success);color:white;padding:10px 16px;border-radius:8px;opacity:0;transition:opacity .25s}
  #toast.show{opacity:1}

  .hidden{display:none !important}
</style>
</head>
<body>

<div id="loading">Cargando...</div>

<header>
  <div class="header-left">
    <button id="menuBtn" class="menu-btn" title="Men√∫">‚ò∞</button>
    <button id="themeToggle" class="theme-btn" title="Cambiar tema">‚òÄÔ∏è</button>
    <button id="installBtn" class="install-btn hidden" title="Instalar app">‚¨áÔ∏è Instalar</button>
    <div id="menuDrop" class="menu-dropdown">
      <button id="goRegistro">Registro</button>
      <button id="goStats">Estad√≠sticas</button>
      <button id="goCalc">Calculadora</button>
    </div>
  </div>

  <div id="user-info" style="display:none">
    <span id="activeUserShort"></span>
    <button id="logout">Cerrar sesi√≥n</button>
  </div>
</header>

<main>
  <div id="content" class="hidden">
    <!-- REGISTRO -->
    <div id="view-registro">
      <div class="topbar">
        <button id="chipCUP" class="chip active" title="Ver CUP">CUP: <strong id="totalCUP">0</strong></button>
        <button id="chipUSD" class="chip" title="Ver USD">USD: <strong id="totalUSD">0</strong></button>
        <select id="filterSelect" class="filter" title="Filtrar">
          <option value="ALL">Todos</option>
          <option value="TODAY">Hoy</option>
          <option value="YESTERDAY">Ayer</option>
          <option value="TODAY_YESTERDAY">Ayer-Hoy</option>
          <option value="LAST_CHECK">√öltimo CheckBox</option>
        </select>
        <div style="margin-left:auto;display:flex;gap:6px">
          <button id="btnEntrada" class="btn green">Entrada</button>
          <button id="btnSalida" class="btn red">Salida</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tabla">
          <thead>
            <tr>
              <th class="nowrap">Fecha</th>
              <th class="num">Entradas</th>
              <th class="num">Salidas</th>
              <th style="min-width:120px">Descripci√≥n</th>
              <th class="num">Saldo</th>
              <th class="num" style="width:1%">‚úî</th>
              <th class="num" style="width:1%">‚úèÔ∏è</th>
              <th class="num" style="width:1%">üóë</th>
              <th class="nowrap" style="width:1%">Por</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="pagination">
        <span id="pageInfo" style="margin-right:auto;color:var(--muted)"></span>
        <button id="prevPage">‚óÄÔ∏è Anterior</button>
        <button id="nextPage">Siguiente ‚ñ∂Ô∏è</button>
      </div>
    </div>

    <!-- ESTAD√çSTICAS -->
    <div id="view-stats" class="hidden">
      <div class="stats-topbar">
        <button id="chipCUP_stats" class="chip">CUP</button>
        <button id="chipUSD_stats" class="chip">USD</button>
      </div>
      <div class="cards">
        <div class="card-kpi"><h4>Salidas totales (√∫ltimos 30 d√≠as)</h4><div id="kpi-salidas-30" class="val">0</div></div>
        <div class="card-kpi"><h4>Promedio diario (√∫ltimos 30 d√≠as)</h4><div id="kpi-promedio-30" class="val">0</div></div>
        <div class="card-kpi"><h4>Checkbox marcados (30 d√≠as)</h4><div id="kpi-checks-30" class="val">0</div></div>
        <div class="card-kpi"><h4>Moneda</h4><div id="kpi-moneda" class="val">CUP</div></div>
      </div>
      <div class="months" style="margin-top:8px;">
        <table>
          <thead><tr><th>Mes</th><th class="num">Salidas</th></tr></thead>
          <tbody id="months-body"></tbody>
        </table>
      </div>
    </div>

    <!-- CALCULADORA -->
    <div id="view-calc" class="hidden">
      <div class="calc-topbar">
        <button id="chipCUP_calc" class="chip">CUP</button>
        <button id="chipUSD_calc" class="chip">USD</button>
        <div style="margin-left:auto"></div>
        <button id="btnNewCalc" class="btn blue">Nuevo c√°lculo</button>
      </div>
      <p class="muted">Al entrar aqu√≠ se abre la calculadora autom√°ticamente.</p>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login" class="login-wrap">
    <div class="card">
      <h2>Iniciar sesi√≥n</h2>
      <div id="loginError" class="login-error"></div>
      <div class="field"><label for="email">Correo</label><input id="email" type="email" placeholder="tu@correo.com" autocomplete="username" /></div>
      <div class="field"><label for="password">Contrase√±a</label><input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" /></div>
      <button id="loginBtn" class="login-btn">Iniciar sesi√≥n</button>
      <div class="hint">Usuarios: Javi, Amaury y Yani</div>
    </div>
  </div>
</main>

<div id="toast">Operaci√≥n registrada correctamente</div>

<template id="rowTpl">
  <tr>
    <td data-k="fecha" class="nowrap"></td>
    <td data-k="entradas" class="num"></td>
    <td data-k="salidas" class="num"></td>
    <td data-k="desc"></td>
    <td data-k="saldo" class="num"></td>
    <td class="num"><input type="checkbox" class="check" title="Verificado" /></td>
    <td class="num"><button class="edit" title="Editar" style="background:transparent;border:none;cursor:pointer;font-size:16px">‚úèÔ∏è</button></td>
    <td class="num">
      <button class="del" title="Eliminar" style="background:transparent;border:none;cursor:pointer;display:inline-flex;align-items:center" aria-label="Eliminar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
          <path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
        </svg>
      </button>
    </td>
    <td data-k="by" class="nowrap"></td>
  </tr>
</template>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  /* ===== Supabase ===== */
  const SUPABASE_URL  = "https://mcmzclmbpohddblpulmn.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbXpjbG1icG9oZGRibHB1bG1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5ODM5OTMsImV4cCI6MjA3NTU1OTk5M30.bdxIDJXk-ovzaGhz3GaQV740bHA0r9sLC4Io8QEOAR0";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  /* ===== Push (datos del proyecto) ===== */
  const VAPID_PUBLIC_KEY = "BGwlTsTs46JJT3KkUkTYKrh_3eocHNKI6QaNvv-a3ufgHAnwsv9vn2wTkymdlccVhLSZYCm6VGySCxcKj2S4p9w";
  // üëâ Usa tu funci√≥n que ya responde:
  const FUNCTION_BASE = "https://mcmzclmbpohddblpulmn.supabase.co/functions/v1/super-processor";

  /* ===== Estado global ===== */
  const $ = s => document.querySelector(s);
  window.opsAll = [];
  window.currentCurrency = 'CUP';
  window.currentFilter = 'ALL';
  window.PAGE_SIZE = 15;
  window.page = 1;
  window.activeView = 'registro';
  window.currentUserEmail = null;

  /* ===== PWA: SW + install prompt (solo en HTTPS/localhost) ===== */
  if ('serviceWorker' in navigator && window.isSecureContext && location.protocol.startsWith('http')) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js').catch(console.error);
    });
  } else {
    console.warn('SW desactivado (no es contexto seguro o no soportado).');
  }
  let deferredPrompt = null;
  const installBtn = $('#installBtn');
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
  });
  installBtn?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    if (outcome === 'accepted') installBtn.classList.add('hidden');
    deferredPrompt = null;
  });
  window.addEventListener('appinstalled', () => installBtn.classList.add('hidden'));

  /* ===== Tema ===== */
  function applyTheme(initial){
    const prefers = initial ?? localStorage.getItem('theme') ?? 'light';
    document.body.classList.toggle('dark', prefers==='dark');
    $('#themeToggle').textContent = prefers==='dark' ? 'üåô' : '‚òÄÔ∏è';
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    if (metaTheme) metaTheme.setAttribute('content', prefers==='dark' ? '#0b1220' : '#2563eb');
  }
  applyTheme();
  $('#themeToggle').onclick = () => {
    const dark = !document.body.classList.contains('dark');
    document.body.classList.toggle('dark', dark);
    localStorage.setItem('theme', dark ? 'dark' : 'light');
    $('#themeToggle').textContent = dark ? 'üåô' : '‚òÄÔ∏è';
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    if (metaTheme) metaTheme.setAttribute('content', dark ? '#0b1220' : '#2563eb');
  };

  /* ===== Helpers ===== */
  function shortNameByEmail(email){
    if(!email) return '';
    if(email.startsWith('javierernestoguerra')) return 'Javi';
    if(email.startsWith('amaurymelo')) return 'Amaury';
    if(email.startsWith('yanilsamendez')) return 'Yani';
    const n = email.split('@')[0];
    return n.charAt(0).toUpperCase()+n.slice(1);
  }
  function fmtNum(n){return(Number(n)||0).toLocaleString('es-ES',{maximumFractionDigits:2})}
  function fmtDateShortISO(i){const d=new Date(i);return`${d.getDate()}-${d.getMonth()+1}-${String(d.getFullYear()).slice(-2)}`}
  function toYMD(d){const x=new Date(d);return`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`}
  function ymdOffset(days){const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()+days);return toYMD(d)}
  function toast(m='Operaci√≥n registrada'){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700)}
  function startOfMonth(d){const x=new Date(d.getFullYear(), d.getMonth(), 1);x.setHours(0,0,0,0);return x;}
  function endOfMonth(d){return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999);}

  /* ===== Login ===== */
  async function doLogin(email,password){
    $('#loginError').textContent='';
    const {error}=await supabase.auth.signInWithPassword({email,password});
    if(error){$('#loginError').textContent=error.message;return false;}
    return true;
  }
  $('#loginBtn').onclick=async()=>{
    const email=$('#email').value.trim(),pass=$('#password').value;
    if(!email||!pass){$('#loginError').textContent='Completa correo y contrase√±a.';return;}
    await doLogin(email,pass);
  };
  $('#password').addEventListener('keydown',e=>{ if(e.key==='Enter')$('#loginBtn').click(); });

  /* Logout */
  $('#logout').onclick=async()=>{
    await supabase.auth.signOut();
    localStorage.removeItem('sb-access-token');
    localStorage.removeItem('supabase.auth.token');
    $('#user-info').style.display='none';
    $('#content').classList.add('hidden');
    $('#login').classList.remove('hidden');
  };

  /* ===== PUSH: suscripci√≥n del navegador ===== */
  async function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(base64);
    const outputArray = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) outputArray[i] = raw.charCodeAt(i);
    return outputArray;
  }
  async function ensurePushSubscribed(userEmail){
    try{
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
      const reg = await navigator.serviceWorker.ready;

      let perm = Notification.permission;
      if (perm === 'default') perm = await Notification.requestPermission();
      if (perm !== 'granted') return;

      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        sub = await reg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: await urlBase64ToUint8Array(VAPID_PUBLIC_KEY),
        });
      }

      // FIX: usar FUNCTION_BASE correcto y sin duplicar el nombre de la funci√≥n
      await fetch(`${FUNCTION_BASE}/register`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ subscription: sub.toJSON(), user_email: userEmail })
      });
    }catch(err){
      console.warn('Push subscribe error:', err);
    }
  }

  /* ===== Sesi√≥n + Loader + inicio ===== */
  document.getElementById('loading').style.display='flex';
  supabase.auth.onAuthStateChange((_,session)=>{
    const logged=!!session;
    if(logged){
      window.currentUserEmail = session.user.email;
      const short = shortNameByEmail(window.currentUserEmail);
      $('#user-info').style.display='flex';
      $('#activeUserShort').textContent = short;
      $('#login').classList.add('hidden');
      $('#content').classList.remove('hidden');
      startRealtime(); fetchAll();
      // suscribir push
      ensurePushSubscribed(session.user.email);
    }else{
      window.currentUserEmail = null;
      $('#user-info').style.display='none';
      $('#content').classList.add('hidden');
      $('#login').classList.remove('hidden');
    }
    document.getElementById('loading').style.display='none';
  });

  /* ===== Realtime + carga ===== */
  async function fetchAll(){
    const {data,error}=await supabase.from('operations').select('*').order('date',{ascending:true});
    if(!error){
      window.opsAll=data||[];
      if(activeView==='registro'){ page=getTotalPages(); render(); }
      else if(activeView==='stats'){ renderStats(); }
      else if(activeView==='calc'){ updateCalcChips(); }
    }
  }
  let channel=null;
  function startRealtime(){
    if(channel) supabase.removeChannel(channel);
    channel=supabase.channel('realtime:operations_all')
      .on('postgres_changes',{event:'*',schema:'public',table:'operations'},
        payload=>{ console.log('Evento realtime:',payload); fetchAll(); })
      .subscribe(status=>console.log('Estado canal:',status));
  }

  /* ===== Totales / filtros ===== */
  function calcTotals(){
    const asc=[...opsAll].sort((a,b)=>new Date(a.date)-new Date(b.date));
    let sC=0,sU=0,m=new Map();
    asc.forEach(o=>{
      const d=(o.type==='Entrada'?1:-1)*(+o.amount||0);
      if(o.currency==='CUP'){sC+=d;m.set(o.id,{saldo:sC});}
      if(o.currency==='USD'){sU+=d;m.set(o.id,{saldo:sU});}
    });
    $('#totalCUP').textContent=fmtNum(sC);
    $('#totalUSD').textContent=fmtNum(sU);
    return {map:m, cup:sC, usd:sU};
  }
  function applyFilter(list){
    const f=currentFilter; if(f==='ALL')return list;
    const t=ymdOffset(0),y=ymdOffset(-1);
    if(f==='TODAY')return list.filter(o=>toYMD(o.date)===t);
    if(f==='YESTERDAY')return list.filter(o=>toYMD(o.date)===y);
    if(f==='TODAY_YESTERDAY')return list.filter(o=>[t,y].includes(toYMD(o.date)));
    if(f==='LAST_CHECK'){
      const asc=[...list].sort((a,b)=>new Date(a.date)-new Date(b.date));
      const last=asc.map((o,i)=>({o,i})).reverse().find(x=>x.o.verified)?.i??-1;
      return last===-1?asc:asc.slice(last);
    }
    return list;
  }
  function filteredRows(){
    const totals=calcTotals();
    let base=[...opsAll].filter(o=>o.currency===currentCurrency).sort((a,b)=>new Date(a.date)-new Date(b.date));
    base=applyFilter(base);
    return base.map(o=>({...o,
      saldo:(totals.map.get(o.id)||{}).saldo||0,
      entradas:o.type==='Entrada'?o.amount:0,
      salidas:o.type==='Salida'?o.amount:0}));
  }
  function getTotalPages(){
    let l=[...opsAll].filter(o=>o.currency===currentCurrency).sort((a,b)=>new Date(a.date)-new Date(b.date));
    l=applyFilter(l); return Math.max(1,Math.ceil(l.length/PAGE_SIZE));
  }

  /* ===== CRUD ===== */
  async function addOperation(d){
    const added_by = shortNameByEmail(currentUserEmail);
    const payload = {...d, added_by};
    const {error}=await supabase.from('operations').insert(payload);
    if(error) alert('Insert: '+error.message);
  }
  async function editOperation(id,u){
    const{error}=await supabase.from('operations').update(u).eq('id',id);
    if(error) alert('Update: '+error.message);
  }
  async function deleteOperation(id){
    const{error}=await supabase.from('operations').delete().eq('id',id);
    if(error) alert('Delete: '+error.message);
  }
  async function toggleVerified(id,v){
    const{error}=await supabase.from('operations').update({verified:!!v}).eq('id',id);
    if(error) alert('Check: '+error.message);
  }

  /* ===== Render Registro ===== */
  function render(){
    const tb=$('#tabla tbody');tb.innerHTML='';
    const rows=filteredRows(); const total=rows.length;
    const totP=Math.max(1,Math.ceil(total/PAGE_SIZE));
    if(page>totP)page=totP;
    const s=(page-1)*PAGE_SIZE,e=s+PAGE_SIZE,pag=rows.slice(s,e);
    const tpl=$('#rowTpl');
    pag.forEach(o=>{
      const tr=tpl.content.cloneNode(true);
      tr.querySelector('[data-k="fecha"]').textContent=fmtDateShortISO(o.date);
      tr.querySelector('[data-k="entradas"]').textContent=o.entradas?fmtNum(o.entradas):'';
      tr.querySelector('[data-k="salidas"]').textContent=o.salidas?fmtNum(o.salidas):'';
      tr.querySelector('[data-k="desc"]').textContent=o.description||'';
      tr.querySelector('[data-k="saldo"]').textContent=fmtNum(o.saldo||0);
      tr.querySelector('[data-k="by"]').textContent=o.added_by || '-';
      const row=tr.querySelector('tr');
      if(o.verified)row.classList.add('verified');
      const chk=tr.querySelector('.check');
      chk.checked=!!o.verified;
      chk.onchange=()=>{toggleVerified(o.id,chk.checked);row.classList.toggle('verified',chk.checked);}
      tr.querySelector('.edit').onclick=()=>openEditModal(o);
      tr.querySelector('.del').onclick=()=>{if(confirm('¬øEliminar?'))deleteOperation(o.id);}
      tb.appendChild(tr);
    });
    $('#pageInfo').textContent=`${currentCurrency} ‚Äî P√°gina ${page} de ${totP} ‚Äî ${total} ops`;
    $('#prevPage').disabled=page<=1;
    $('#nextPage').disabled=page>=totP;
  }
  window.render = render;

  /* ===== Estad√≠sticas ===== */
  function paintStatsChips(){
    const c1=$('#chipCUP_stats'),c2=$('#chipUSD_stats');
    if(!c1||!c2) return;
    if(currentCurrency==='CUP'){c1.classList.add('active');c2.classList.remove('active');}
    else {c2.classList.add('active');c1.classList.remove('active');}
    $('#kpi-moneda').textContent=currentCurrency;
  }
  function renderStats(){
    const cur=currentCurrency;
    const list=(opsAll||[]).filter(o=>o.currency===cur);

    const now=new Date();now.setHours(23,59,59,999);
    const from30=new Date(now);from30.setDate(from30.getDate()-29);from30.setHours(0,0,0,0);
    const last30=list.filter(o=>{const d=new Date(o.date);return d>=from30&&d<=now;});

    const salidas30=last30.filter(o=>o.type==='Salida').reduce((a,o)=>a+(+o.amount||0),0);
    const promedio30=salidas30/30;
    const checks30=last30.filter(o=>!!o.verified).length;

    const today=new Date(); const months=[];
    for(let i=0;i<3;i++){
      const ref=new Date(today.getFullYear(), today.getMonth()-i, 1);
      const label=ref.toLocaleString('es-ES',{month:'long'});
      const a=startOfMonth(ref), b=endOfMonth(ref);
      const totalMonth=list.filter(o=>{const d=new Date(o.date);return d>=a&&d<=b&&o.type==='Salida';})
                           .reduce((acc,o)=>acc+(+o.amount||0),0);
      months.push({label:label.charAt(0).toUpperCase()+label.slice(1), total:totalMonth});
    }

    $('#kpi-salidas-30').textContent=fmtNum(salidas30);
    $('#kpi-promedio-30').textContent=fmtNum(promedio30);
    $('#kpi-checks-30').textContent=fmtNum(checks30);

    const mb=$('#months-body'); mb.innerHTML='';
    months.reverse().forEach(m=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); td1.textContent=m.label;
      const td2=document.createElement('td'); td2.className='num'; td2.textContent=fmtNum(m.total);
      tr.appendChild(td1); tr.appendChild(td2); mb.appendChild(tr);
    });
  }

  /* ===== Calculadora ===== */
  function paintCalcChips(){
    const c1=$('#chipCUP_calc'),c2=$('#chipUSD_calc');
    if(!c1||!c2) return;
    if(currentCurrency==='CUP'){c1.classList.add('active');c2.classList.remove('active');}
    else {c2.classList.add('active');c1.classList.remove('active');}
  }
  function updateCalcChips(){ paintCalcChips(); }
  function openCalcModal(){
    const totals=calcTotals();
    const fondo=currentCurrency==='CUP'?totals.cup:totals.usd;
    const bg=document.createElement('div');bg.className='modal-bg';
    const m=document.createElement('div');m.className='modal';
    m.innerHTML=`
      <button class="close">‚úñ</button>
      <h3>Calculadora (${currentCurrency})</h3>
      <label>Fondo actual (${currentCurrency})
        <input id="calc-fondo" type="number" value="${Number(fondo).toFixed(2)}" readonly />
      </label>
      <label>Dinero f√≠sico contado
        <input id="calc-fisico" type="number" inputmode="decimal" placeholder="0" />
      </label>
      <div id="calc-msg" class="muted">Escribe el efectivo f√≠sico para comparar‚Ä¶</div>
      <button class="ok">Cerrar</button>
    `;
    const close=()=>bg.remove(); m.querySelector('.close').onclick=close; bg.onclick=e=>{if(e.target===bg)close();}
    m.querySelector('.ok').onclick=close;
    const fisico=m.querySelector('#calc-fisico'); const msg=m.querySelector('#calc-msg');
    function recompute(){
      const f=parseFloat(m.querySelector('#calc-fondo').value)||0;
      const x=parseFloat(fisico.value)||0; const diff=f-x;
      if(Math.abs(diff)<1e-6){ msg.textContent='Todo est√° Cuadrado ‚úÖ'; msg.style.color='var(--success)'; }
      else if(diff>0){ msg.textContent=`Falta una Salida de ${fmtNum(diff)}`; msg.style.color='var(--danger)'; }
      else { msg.textContent=`Sobra ${fmtNum(Math.abs(diff))} de dinero f√≠sico`; msg.style.color='var(--primary)'; }
    }
    fisico.addEventListener('input',recompute);
    bg.appendChild(m);document.body.appendChild(bg); setTimeout(()=>fisico.focus(),50);
  }

  /* ===== Modales Registro ====== */
  function openQuickModal(tipo){
    const bg=document.createElement('div');bg.className='modal-bg';
    const m=document.createElement('div');m.className='modal';
    m.innerHTML=`<button class="close">‚úñ</button><h3>${tipo}</h3>
      <label>Monto<input id="monto" type="number" placeholder="0" inputmode="decimal"/></label>
      <label>Descripci√≥n<input id="desc" type="text" placeholder="Obligatorio"/></label>
      <button class="ok">Registrar</button>`;
    const close=()=>bg.remove(); m.querySelector('.close').onclick=close; bg.onclick=e=>{if(e.target===bg)close();}
    m.querySelector('.ok').onclick=async()=>{
      const monto=+m.querySelector('#monto').value||0;
      const desc=m.querySelector('#desc').value.trim();
      if(monto<=0){alert('Monto inv√°lido');return;}
      if(!desc){alert('Descripci√≥n obligatoria');return;}
      await addOperation({currency:currentCurrency,type:tipo,amount:monto,description:desc});
      toast(); page=getTotalPages(); render(); close();
    };
    bg.appendChild(m);document.body.appendChild(bg);
  }
  function openEditModal(op){
    const bg=document.createElement('div');bg.className='modal-bg';
    const m=document.createElement('div');m.className='modal';
    m.innerHTML=`<button class="close">‚úñ</button><h3>Editar</h3>
      <div style="display:flex;gap:6px"><button class="tEntrada btn">Entrada</button><button class="tSalida btn">Salida</button></div>
      <label>Monto<input id="monto" type="number" value="${op.amount}"/></label>
      <label>Descripci√≥n<input id="desc" type="text" value="${op.description||''}"/></label>
      <button class="ok">Guardar</button>`;
    let tipo=op.type;
    const paint=()=>{m.querySelector('.tEntrada').style.background=tipo==='Entrada'?'var(--primary)':'var(--thead)';
      m.querySelector('.tEntrada').style.color=tipo==='Entrada'?'#fff':'var(--text)';
      m.querySelector('.tSalida').style.background=tipo==='Salida'?'var(--primary)':'var(--thead)';
      m.querySelector('.tSalida').style.color=tipo==='Salida'?'#fff':'var(--text)';};
    paint();
    m.querySelector('.tEntrada').onclick=()=>{tipo='Entrada';paint();};
    m.querySelector('.tSalida').onclick=()=>{tipo='Salida';paint();};
    m.querySelector('.ok').onclick=async()=>{
      const monto=+m.querySelector('#monto').value||0;
      const desc=m.querySelector('#desc').value.trim();
      if(monto<=0){alert('Monto inv√°lido');return;}
      if(!desc){alert('Descripci√≥n obligatoria');return;}
      await editOperation(op.id,{type:tipo,amount:monto,description:desc});
      toast('Guardado'); if(activeView==='registro') render(); else renderStats(); bg.remove();
    };
    m.querySelector('.close').onclick=()=>bg.remove();
    bg.onclick=e=>{if(e.target===bg)bg.remove();}
    bg.appendChild(m);document.body.appendChild(bg);
  }

  /* ===== Navegaci√≥n ===== */
  function showView(view){
    activeView=view;
    const vReg=$('#view-registro'), vSta=$('#view-stats'), vCal=$('#view-calc');
    if(view==='registro'){
      vReg.classList.remove('hidden'); vSta.classList.add('hidden'); vCal.classList.add('hidden');
      page=getTotalPages(); render();
    }else if(view==='stats'){
      vSta.classList.remove('hidden'); vReg.classList.add('hidden'); vCal.classList.add('hidden');
      paintStatsChips(); renderStats();
    }else{
      vCal.classList.remove('hidden'); vReg.classList.add('hidden'); vSta.classList.add('hidden');
      paintCalcChips(); openCalcModal();
    }
  }

  function attach(){
    const menuBtn=$('#menuBtn'),menuDrop=$('#menuDrop');
    if(menuBtn){
      menuBtn.onclick=()=>{const open=menuDrop.style.display==='block';menuDrop.style.display=open?'none':'block';};
      document.addEventListener('click',e=>{ if(!menuDrop.contains(e.target)&&e.target!==menuBtn){menuDrop.style.display='none';} });
    }
    $('#goRegistro')?.addEventListener('click',()=>{menuDrop.style.display='none';showView('registro');});
    $('#goStats')?.addEventListener('click',()=>{menuDrop.style.display='none';showView('stats');});
    $('#goCalc')?.addEventListener('click',()=>{menuDrop.style.display='none';showView('calc');});

    $('#chipCUP').onclick=()=>{currentCurrency='CUP';$('#chipCUP').classList.add('active');$('#chipUSD').classList.remove('active');
      if(activeView==='registro'){page=getTotalPages();render();} else if(activeView==='stats'){paintStatsChips();renderStats();} else {paintCalcChips();openCalcModal();}};
    $('#chipUSD').onclick=()=>{currentCurrency='USD';$('#chipUSD').classList.add('active');$('#chipCUP').classList.remove('active');
      if(activeView==='registro'){page=getTotalPages();render();} else if(activeView==='stats'){paintStatsChips();renderStats();} else {paintCalcChips();openCalcModal();}};

    $('#chipCUP_stats').onclick=()=>{currentCurrency='CUP';paintStatsChips();renderStats();};
    $('#chipUSD_stats').onclick=()=>{currentCurrency='USD';paintStatsChips();renderStats();};

    $('#chipCUP_calc').onclick=()=>{currentCurrency='CUP';paintCalcChips();openCalcModal();};
    $('#chipUSD_calc').onclick=()=>{currentCurrency='USD';paintCalcChips();openCalcModal();};
    $('#btnNewCalc').onclick=()=>openCalcModal();

    $('#btnEntrada').onclick=()=>openQuickModal('Entrada');
    $('#btnSalida').onclick=()=>openQuickModal('Salida');

    $('#filterSelect').onchange=e=>{currentFilter=e.target.value;page=getTotalPages();render();};
    $('#prevPage').onclick=()=>{if(page>1){page--;render();}};
    $('#nextPage').onclick=()=>{const t=getTotalPages();if(page<t){page++;render();}};
  }
  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',attach);else attach();
</script>
</body>
</html>
