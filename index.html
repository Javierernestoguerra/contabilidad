<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Control de Fondos CUP/USD ‚Äì Supabase</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Segoe UI,Arial,sans-serif}
  body{background:#f6f7fb;color:#0f172a;display:flex;flex-direction:column;min-height:100vh}

  /* Header */
  header{background:#ffffff;border-bottom:1px solid #e2e8f0;padding:8px 12px;display:flex;justify-content:flex-end;align-items:center;gap:10px}
  #user-info{font-size:14px;display:flex;align-items:center;gap:10px}
  #logout{background:#dc2626;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}

  main{flex:1;display:flex;flex-direction:column}
  #content{flex:1;display:flex;flex-direction:column;gap:8px;padding:8px}

  /* Topbar: chips, filtro y acciones */
  .topbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .chip{padding:4px 8px;border:1px solid #e2e8f0;border-radius:999px;background:#ffffff;font-size:12px;cursor:pointer}
  .chip strong{font-weight:800}
  .chip.active{border-color:#2563eb;color:#2563eb;background:#eff6ff}
  .filter{padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;font-size:12px;background:#fff}
  .btn{padding:8px 12px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
  .btn.green{background:#16a34a;color:#fff}
  .btn.red{background:#dc2626;color:#fff}

  /* Tabla */
  .table-wrap{overflow:auto;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #e5e7eb;padding:6px 6px;font-size:13px;vertical-align:middle}
  th{background:#f1f5f9;color:#0f172a;text-align:left;position:sticky;top:0;z-index:1}
  td.num{text-align:right;font-variant-numeric:tabular-nums}
  tr.verified{background:#dcfce7 !important}
  .nowrap{white-space:nowrap}

  /* Paginaci√≥n */
  .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
  .pagination button{padding:8px 12px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;cursor:pointer}

  /* Modal */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:100}
  .modal{background:#fff;padding:16px;border-radius:12px;width:92%;max-width:420px;position:relative;display:flex;flex-direction:column;gap:10px}
  .modal .close{position:absolute;right:10px;top:10px;background:transparent;border:none;font-size:18px;cursor:pointer}
  .modal label{display:flex;flex-direction:column;gap:6px}
  .modal input{padding:10px;border:1px solid #cbd5e1;border-radius:8px}
  .modal .ok{background:#2563eb;color:#fff;border:none;padding:10px;border-radius:8px;font-weight:700;cursor:pointer}

  /* Login moderno */
  .login-wrap{
    flex:1;display:flex;align-items:center;justify-content:center;
    background: linear-gradient(135deg,#2e62ff 0%, #6b3dfd 100%);
    padding:24px;
  }
  .card{
    width:100%;max-width:380px;background:#fff;border-radius:16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.15);
    padding:20px 18px; display:flex; flex-direction:column; gap:12px;
  }
  .card h2{font-size:22px;text-align:center;margin-bottom:8px;color:#111827}
  .field{display:flex;flex-direction:column;gap:6px}
  .field label{font-size:12px;color:#475569}
  .field input{
    padding:12px;border:1px solid #cbd5e1;border-radius:10px;font-size:14px
  }
  .login-btn{
    margin-top:4px;padding:12px;border:none;border-radius:10px;
    background:#2563eb;color:#fff;font-weight:700;cursor:pointer
  }
  .login-error{color:#dc2626;font-size:12px;min-height:16px;text-align:center}
  .hint{font-size:12px;color:#64748b;text-align:center}

  #toast{position:fixed;bottom:16px;right:16px;background:#16a34a;color:white;padding:10px 16px;border-radius:8px;opacity:0;transition:opacity .25s}
  #toast.show{opacity:1}

  .hidden{display:none !important}
</style>
</head>
<body>
<header>
  <div id="user-info" style="display:none">
    Sesi√≥n: <span id="activeUser"></span>
    <button id="logout">Cerrar sesi√≥n</button>
  </div>
</header>

<main>
  <!-- App -->
  <div id="content" class="hidden">
    <div class="topbar">
      <button id="chipCUP" class="chip active" title="Ver CUP">CUP: <strong id="totalCUP">0</strong></button>
      <button id="chipUSD" class="chip" title="Ver USD">USD: <strong id="totalUSD">0</strong></button>
      <select id="filterSelect" class="filter" title="Filtrar">
        <option value="ALL">Todos</option>
        <option value="TODAY">Hoy</option>
        <option value="YESTERDAY">Ayer</option>
        <option value="TODAY_YESTERDAY">Ayer-Hoy</option>
        <option value="LAST_CHECK">√öltimo CheckBox</option>
      </select>
      <div style="margin-left:auto;display:flex;gap:6px">
        <button id="btnEntrada" class="btn green">Entrada</button>
        <button id="btnSalida" class="btn red">Salida</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tabla">
        <thead>
          <tr>
            <th style="width:1%;" class="nowrap">Fecha</th>
            <th class="num">Entradas</th>
            <th class="num">Salidas</th>
            <th style="min-width:120px">Descripci√≥n</th>
            <th class="num">Saldo</th>
            <th class="num" style="width:1%">‚úî</th>
            <th class="num" style="width:1%">‚úèÔ∏è</th>
            <th class="num" style="width:1%">üóë</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pagination">
      <span id="pageInfo" style="margin-right:auto;color:#475569"></span>
      <button id="prevPage">‚óÄÔ∏è Anterior</button>
      <button id="nextPage">Siguiente ‚ñ∂Ô∏è</button>
    </div>
  </div>

  <!-- Login moderno -->
  <div id="login" class="login-wrap">
    <div class="card">
      <h2>Iniciar sesi√≥n</h2>
      <div id="loginError" class="login-error"></div>
      <div class="field">
        <label for="email">Correo</label>
        <input id="email" type="email" placeholder="tu@correo.com" autocomplete="username" />
      </div>
      <div class="field">
        <label for="password">Contrase√±a</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
      </div>
      <button id="loginBtn" class="login-btn">Iniciar sesi√≥n</button>
      <div class="hint">Usuarios configurados: Javi, Amaury y Yanilsa</div>
    </div>
  </div>
</main>

<div id="toast">Operaci√≥n registrada correctamente</div>

<template id="rowTpl">
  <tr>
    <td data-k="fecha" class="nowrap"></td>
    <td data-k="entradas" class="num"></td>
    <td data-k="salidas" class="num"></td>
    <td data-k="desc"></td>
    <td data-k="saldo" class="num"></td>
    <td class="num"><input type="checkbox" class="check" title="Verificado" /></td>
    <td class="num"><button class="edit" title="Editar" style="background:transparent;border:none;cursor:pointer;font-size:16px">‚úèÔ∏è</button></td>
    <td class="num">
      <button class="del" title="Eliminar" style="background:transparent;border:none;cursor:pointer;display:inline-flex;align-items:center" aria-label="Eliminar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"/>
          <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
          <path d="M10 11v6"/>
          <path d="M14 11v6"/>
          <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
        </svg>
      </button>
    </td>
  </tr>
</template>

<!-- ===================== SUPABASE SDK & INTEGRACI√ìN ===================== -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // Tus credenciales (anon key p√∫blica)
  const SUPABASE_URL  = "https://mcmzclmbpohddblpulmn.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jbXpjbG1icG9oZGRibHB1bG1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5ODM5OTMsImV4cCI6MjA3NTU1OTk5M30.bdxIDJXk-ovzaGhz3GaQV740bHA0r9sLC4Io8QEOAR0";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // --------- ESTADO GLOBAL ----------
  window.opsAll = [];         // todas las operaciones (ambas monedas)
  window.currentCurrency = 'CUP';
  window.currentFilter   = 'ALL';  // ALL | TODAY | YESTERDAY | TODAY_YESTERDAY | LAST_CHECK
  window.PAGE_SIZE = 15;
  window.page = 1;

  // --------- LOGIN ----------
  const $ = s => document.querySelector(s);

  async function doLogin(email, password){
    $('#loginError').textContent = '';
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      $('#loginError').textContent = error.message;
      return false;
    }
    return true;
  }

  $('#loginBtn').addEventListener('click', async () => {
    const email = $('#email').value.trim();
    const password = $('#password').value;
    if(!email || !password){
      $('#loginError').textContent = 'Completa correo y contrase√±a.';
      return;
    }
    await doLogin(email, password);
  });

  $('#password').addEventListener('keydown', async (e)=>{
    if(e.key==='Enter'){
      const email = $('#email').value.trim();
      const password = $('#password').value;
      await doLogin(email, password);
    }
  });

  $('#logout').addEventListener('click', async ()=>{
    await supabase.auth.signOut();
    location.reload();
  });

  // --------- REALTIME & FETCH ----------
  async function fetchAll(){
    const { data, error } = await supabase
      .from('operations')
      .select('*')
      .order('date', { ascending: true });
    if(!error){
      window.opsAll = data || [];
      window.page = getTotalPages(); // ir a √∫ltima p√°gina siempre al refrescar
      window.render();
    }
  }

  // Suscripci√≥n global a cualquier cambio
  let channel = null;
  function startRealtime(){
    if(channel) supabase.removeChannel(channel);
    channel = supabase.channel('realtime:operations_all')
      .on('postgres_changes',
        { event: '*', schema: 'public', table: 'operations' },
        () => fetchAll() // recargar todo al cambiar algo
      )
      .subscribe();
  }

  // Estado de sesi√≥n ‚Üí UI
  supabase.auth.onAuthStateChange((event, session) => {
    const logged = !!session;
    if (logged) {
      $('#user-info').style.display = 'flex';
      $('#activeUser').textContent = session.user.email;
      $('#login').classList.add('hidden');
      $('#content').classList.remove('hidden');
      startRealtime();
      fetchAll();
    } else {
      $('#user-info').style.display = 'none';
      $('#content').classList.add('hidden');
      $('#login').classList.remove('hidden');
    }
  });

  // --------- CRUD helpers ----------
  window.addOperation = async ({ currency, type, amount, description }) => {
    const { error } = await supabase.from('operations').insert({
      currency, type, amount: Number(amount), description
    });
    if (error) alert('Insert: ' + error.message);
  };

  window.editOperation = async (id, { type, amount, description }) => {
    const { error } = await supabase.from('operations')
      .update({ type, amount: Number(amount), description })
      .eq('id', id);
    if (error) alert('Update: ' + error.message);
  };

  window.deleteOperation = async (id) => {
    const { error } = await supabase.from('operations')
      .delete().eq('id', id);
    if (error) alert('Delete: ' + error.message);
  };

  window.toggleVerified = async (id, value) => {
    const { error } = await supabase.from('operations')
      .update({ verified: !!value }).eq('id', id);
    if (error) alert('Check: ' + error.message);
  };

  // --------- UI L√ìGICA (render, filtros, etc.) ----------
  function fmtNum(n){return (Number(n)||0).toLocaleString('es-ES',{maximumFractionDigits:2})}
  function fmtDateShortISO(iso){const d=new Date(iso);const dd=d.getDate();const mm=d.getMonth()+1;const yy=String(d.getFullYear()).slice(-2);return `${dd}-${mm}-${yy}`}
  function toLocalYMD(date){const d=new Date(date);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
  function ymdOffset(days){const d=new Date();d.setHours(0,0,0,0);d.setDate(d.getDate()+days);return toLocalYMD(d)}
  function toast(msg='Operaci√≥n registrada correctamente'){const t=$('#toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700)}

  function calcTotals(){
    const asc=[...window.opsAll].sort((a,b)=>new Date(a.date)-new Date(b.date));
    let saldoCUP=0, saldoUSD=0; const byId=new Map();
    asc.forEach(o=>{
      const delta=(o.type==='Entrada'?1:-1)*(Number(o.amount)||0);
      if(o.currency==='CUP'){saldoCUP+=delta; byId.set(o.id,{saldo:saldoCUP})}
      else if(o.currency==='USD'){saldoUSD+=delta; byId.set(o.id,{saldo:saldoUSD})}
    });
    $('#totalCUP').textContent=fmtNum(saldoCUP);
    $('#totalUSD').textContent=fmtNum(saldoUSD);
    return byId;
  }

  function applyFilterOnList(list){
    const f = window.currentFilter;
    if(f==='ALL') return list;
    const today=ymdOffset(0), yesterday=ymdOffset(-1);
    if(f==='TODAY') return list.filter(o=>toLocalYMD(o.date)===today);
    if(f==='YESTERDAY') return list.filter(o=>toLocalYMD(o.date)===yesterday);
    if(f==='TODAY_YESTERDAY') return list.filter(o=>{const ymd=toLocalYMD(o.date);return ymd===today||ymd===yesterday;});
    if(f==='LAST_CHECK'){
      const asc=[...list].sort((a,b)=>new Date(a.date)-new Date(b.date));
      const lastIdx=asc.map((o,i)=>({o,i})).reverse().find(x=>x.o.verified)?.i ?? -1;
      if(lastIdx===-1) return asc;
      return asc.slice(lastIdx);
    }
    return list;
  }

  function filteredRows(){
    const saldoMap=calcTotals();
    let base=[...window.opsAll]
      .filter(o=>o.currency===window.currentCurrency)
      .sort((a,b)=>new Date(a.date)-new Date(b.date));
    base=applyFilterOnList(base);
    return base.map(o=>({
      ...o,
      saldo:(saldoMap.get(o.id)||{}).saldo||0,
      entradas:o.type==='Entrada'?o.amount:0,
      salidas:o.type==='Salida'?o.amount:0
    }));
  }

  function getTotalPages(){
    let list=[...window.opsAll].filter(o=>o.currency===window.currentCurrency).sort((a,b)=>new Date(a.date)-new Date(b.date));
    list=applyFilterOnList(list);
    const count=list.length;
    return Math.max(1, Math.ceil(count / window.PAGE_SIZE));
  }

  window.render = function(){
    const tbody=$('#tabla tbody');tbody.innerHTML='';
    const rows=filteredRows();

    const total=rows.length; const totalPages=Math.max(1,Math.ceil(total/window.PAGE_SIZE));
    if(window.page>totalPages) window.page=totalPages;
    const start=(window.page-1)*window.PAGE_SIZE; const end=start+window.PAGE_SIZE; const pageRows=rows.slice(start,end);

    const tpl=$('#rowTpl');
    pageRows.forEach(o=>{
      const tr=tpl.content.cloneNode(true);
      tr.querySelector('[data-k="fecha"]').textContent=fmtDateShortISO(o.date);
      tr.querySelector('[data-k="entradas"]').textContent=o.entradas?fmtNum(o.entradas):'';
      tr.querySelector('[data-k="salidas"]').textContent=o.salidas?fmtNum(o.salidas):'';
      tr.querySelector('[data-k="desc"]').textContent=o.description||'';
      tr.querySelector('[data-k="saldo"]').textContent=fmtNum(o.saldo||0);

      const row=tr.querySelector('tr');
      if(o.verified) row.classList.add('verified');
      const chk=tr.querySelector('.check');
      chk.checked=!!o.verified;
      chk.addEventListener('change',()=>{ toggleVerified(o.id, chk.checked); if(chk.checked) row.classList.add('verified'); else row.classList.remove('verified'); });

      tr.querySelector('.edit').addEventListener('click',()=> openEditModal(o));
      tr.querySelector('.del').addEventListener('click',()=>{ if(confirm('¬øSeguro que deseas eliminar esta operaci√≥n?')) deleteOperation(o.id); });

      tbody.appendChild(tr);
    });

    $('#pageInfo').textContent=`${window.currentCurrency} ‚Äî P√°gina ${window.page} de ${Math.max(1,Math.ceil(total/window.PAGE_SIZE))} ‚Äî ${total} ops`;
    $('#prevPage').disabled = window.page<=1;
    $('#nextPage').disabled = window.page>=Math.ceil(total/window.PAGE_SIZE);
  }

  function openQuickModal(tipo){
    const bg=document.createElement('div'); bg.className='modal-bg';
    const modal=document.createElement('div'); modal.className='modal';
    modal.innerHTML=`
      <button class="close" aria-label="Cerrar">‚úñ</button>
      <h3>${tipo}</h3>
      <label>Monto
        <input id="monto" type="number" inputmode="decimal" placeholder="0" />
      </label>
      <label>Descripci√≥n (obligatoria)
        <input id="desc" type="text" placeholder="Describe la operaci√≥n" />
      </label>
      <button class="ok">Registrar</button>
    `;
    const close=()=>document.body.removeChild(bg);
    modal.querySelector('.close').onclick=close;
    bg.addEventListener('click',e=>{ if(e.target===bg) close(); });
    modal.querySelector('.ok').onclick=async()=>{
      const monto=parseFloat(modal.querySelector('#monto').value)||0;
      const desc=modal.querySelector('#desc').value.trim();
      if(monto<=0){alert('Monto inv√°lido');return;}
      if(!desc){alert('La descripci√≥n es obligatoria');return;}
      await addOperation({ currency: window.currentCurrency, type: tipo, amount: monto, description: desc });
      toast(); window.page = getTotalPages(); window.render(); close();
    };
    bg.appendChild(modal); document.body.appendChild(bg);
  }

  function openEditModal(op){
    const bg=document.createElement('div'); bg.className='modal-bg';
    const modal=document.createElement('div'); modal.className='modal';
    modal.innerHTML=`
      <button class="close" aria-label="Cerrar">‚úñ</button>
      <h3>Editar operaci√≥n</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="tEntrada btn">Entrada</button>
        <button class="tSalida btn">Salida</button>
      </div>
      <label>Monto
        <input id="monto" type="number" inputmode="decimal" value="${op.amount}" />
      </label>
      <label>Descripci√≥n (obligatoria)
        <input id="desc" type="text" value="${op.description||''}" />
      </label>
      <button class="ok">Guardar cambios</button>
    `;
    let tipo=op.type;
    const close=()=>document.body.removeChild(bg);
    modal.querySelector('.close').onclick=close;
    bg.addEventListener('click',e=>{ if(e.target===bg) close(); });

    const tE=modal.querySelector('.tEntrada');
    const tS=modal.querySelector('.tSalida');
    const paint=()=>{
      tE.style.background = (tipo==='Entrada')?'#2563eb':'#e2e8f0';
      tE.style.color = (tipo==='Entrada')?'#fff':'#0f172a';
      tS.style.background = (tipo==='Salida')?'#2563eb':'#e2e8f0';
      tS.style.color = (tipo==='Salida')?'#fff':'#0f172a';
    };
    paint();
    tE.onclick=()=>{ tipo='Entrada'; paint(); };
    tS.onclick=()=>{ tipo='Salida'; paint(); };

    modal.querySelector('.ok').onclick=async()=>{
      const monto=parseFloat(modal.querySelector('#monto').value)||0;
      const desc=modal.querySelector('#desc').value.trim();
      if(monto<=0){alert('Monto inv√°lido');return;}
      if(!desc){alert('La descripci√≥n es obligatoria');return;}
      await editOperation(op.id, { type: tipo, amount: monto, description: desc });
      toast('Cambios guardados'); window.render(); close();
    };
    bg.appendChild(modal); document.body.appendChild(bg);
  }

  // Eventos de UI
  function attachEvents(){
    const chipCUP=$('#chipCUP');
    const chipUSD=$('#chipUSD');
    if(chipCUP) chipCUP.onclick=()=>{ window.currentCurrency='CUP'; chipCUP.classList.add('active'); chipUSD && chipUSD.classList.remove('active'); window.page=getTotalPages(); window.render(); };
    if(chipUSD) chipUSD.onclick=()=>{ window.currentCurrency='USD'; chipUSD.classList.add('active'); chipCUP && chipCUP.classList.remove('active'); window.page=getTotalPages(); window.render(); };

    const btnE=$('#btnEntrada');
    const btnS=$('#btnSalida');
    if(btnE) btnE.onclick=()=>openQuickModal('Entrada');
    if(btnS) btnS.onclick=()=>openQuickModal('Salida');

    const sel=$('#filterSelect');
    if(sel) sel.onchange=(e)=>{ window.currentFilter=e.target.value; window.page=getTotalPages(); window.render(); };

    const prev=$('#prevPage');
    const next=$('#nextPage');
    if(prev) prev.onclick=()=>{ if(window.page>1){window.page--; window.render();} };
    if(next) next.onclick=()=>{ const last=getTotalPages(); if(window.page<last){ window.page++; window.render(); } };
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded',attachEvents);
  }else{ attachEvents(); }

</script>
</body>
</html>
